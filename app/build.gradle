/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/8.14.3/userguide/building_java_projects.html in the Gradle documentation.
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
}

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // Use JUnit test framework.
    testImplementation libs.junit

    // This dependency is used by the application.
    implementation libs.guava
    
    // H2 Database for embedded database
    implementation libs.h2
    
    // JavaFX Controls
    implementation libs.javafx.controls
    implementation libs.javafx.fxml
    
    // Lombok for reducing boilerplate code
    compileOnly libs.lombok
    annotationProcessor libs.lombok
    
    // Spring JDBC for database operations
    implementation libs.spring.jdbc
    
    // Log4j2 for logging
    implementation libs.log4j.api
    implementation libs.log4j.core
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

application {
    // Define the main class for the application.
    mainClass = 'jp.euks.PasswordManager.App'
    
    // JavaFX実行のためのJVMオプション
    applicationDefaultJvmArgs = [
        '--add-opens', 'javafx.controls/javafx.scene.control.skin=ALL-UNNAMED',
        '--add-opens', 'javafx.graphics/javafx.scene=ALL-UNNAMED'
    ]
}

// JREとライブラリを含めた配布用パッケージを作成
task createMinimalJRE {
    description = 'Create minimal JRE with jlink for smaller footprint'
    group = 'distribution'
    doLast {
        def buildDirPath = project.buildDir.absolutePath
        def jreOutputDir = new File("$buildDirPath/jre-minimal")
        
        // 既存のJREディレクトリを削除
        if (jreOutputDir.exists()) {
            logger.lifecycle("Removing existing JRE directory...")
            jreOutputDir.deleteDir()
        }
        
        jreOutputDir.parentFile.mkdirs()
        
        // 必要なモジュール最小限セット
        def modules = 'java.base,java.desktop,java.logging,java.sql,java.naming,jdk.unsupported,java.management'
        
        logger.lifecycle("Creating minimal JRE with jlink...")
        logger.lifecycle("Modules: ${modules}")
        
        def javaHome = System.getenv('JAVA_HOME') ?: System.getProperty('java.home')
        if (!javaHome) {
            throw new GradleException('JAVA_HOME environment variable not set')
        }
        
        def jmodsPath = new File(javaHome, 'jmods')
        if (!jmodsPath.exists()) {
            throw new GradleException("jmods directory not found at: ${jmodsPath.absolutePath}")
        }
        
        logger.lifecycle("Using jmods from: ${jmodsPath.absolutePath}")
        logger.lifecycle("Output directory: ${jreOutputDir.absolutePath}")
        
        try {
            project.exec {
                executable 'cmd.exe'
                args '/c', "\"${new File(javaHome, 'bin/jlink.exe').absolutePath}\" --module-path \"${jmodsPath.absolutePath}\" --add-modules ${modules} --output \"${jreOutputDir.absolutePath}\" --compress 2 --strip-debug --no-header-files --no-man-pages"
            }
        } catch (Exception e) {
            logger.error("jlink command failed.")
            logger.error("JAVA_HOME: ${javaHome}")
            logger.error("jmods path: ${jmodsPath.absolutePath}")
            throw e
        }
        
        logger.lifecycle("✓ Minimal JRE created successfully")
    }
}

task createWindowsDistributionWithJRE {
    description = 'Create Windows distribution with minimal embedded JRE'
    group = 'distribution'
    dependsOn 'build', 'createMinimalJRE'
    doLast {
        def buildDirPath = project.buildDir.absolutePath
        def distDir = new File("$buildDirPath/distribution/PasswordManager")
        def jreSourceDir = new File("$buildDirPath/jre-minimal")
        def jreDestDir = new File("$distDir/jre")
        
        distDir.mkdirs()
        
        // JARファイルをコピー
        logger.lifecycle("Copying application JAR...")
        copy {
            from jar.archiveFile
            into "${distDir.absolutePath}/lib"
        }
        
        // 依存ライブラリをコピー
        logger.lifecycle("Copying dependencies...")
        copy {
            from configurations.runtimeClasspath
            into "${distDir.absolutePath}/lib"
        }
        
        // JREをコピー
        logger.lifecycle("Copying minimal JRE...")
        copy {
            from jreSourceDir
            into jreDestDir.absolutePath
        }
        
        // スタンドアロン実行用バッチファイルを作成
        def runBat = new File(distDir, 'run.bat')
        def runBatContent = '''@echo off
setlocal enabledelayedexpansion
set SCRIPT_DIR=%~dp0
set JRE_HOME=%SCRIPT_DIR%jre
set LIB_DIR=%SCRIPT_DIR%lib

REM ClassPathを構築
set CLASSPATH=
for /r "%LIB_DIR%" %%f in (*.jar) do (
    set CLASSPATH=!CLASSPATH!;%%f
)

REM JavaFXオプション
set JVM_OPTS=--add-opens javafx.controls/javafx.scene.control.skin=ALL-UNNAMED --add-opens javafx.graphics/javafx.scene=ALL-UNNAMED

REM アプリケーション実行
"%JRE_HOME%\\bin\\java.exe" %JVM_OPTS% -cp "%CLASSPATH%" jp.euks.PasswordManager.App

endlocal
'''
        runBat.text = runBatContent
        
        // READMEを作成
        def readmeFile = new File(distDir, 'README.txt')
        def timestamp = new Date().format('yyyy-MM-dd HH:mm:ss')
        def readmeContent = """
PasswordManager - Windows版 (最小限JRE同梱)
=============================================

■ 機能
- パスワードの暗号化保存
- CSVインポート・エクスポート
- 重複エントリーの自動検出・削除

■ 実行方法
1. run.bat をダブルクリック
   または
   コマンドプロンプトから: run.bat

■ ディレクトリ構成
PasswordManager/
  ├── jre/              - Java実行環境（最小限JRE）
  ├── lib/              - アプリケーション及び依存ライブラリ
  ├── run.bat           - 実行ファイル（推奨）
  └── README.txt        - このファイル

■ 動作環境
- OS: Windows 7以上
- その他: すべてのランタイムが同梱されています

■ トラブルシューティング
「run.bat は認識されていません」と表示される場合:
  - run.bat があるディレクトリで右クリック → コマンドプロンプトを開く
  - run.bat と入力して実行

アプリが起動しない場合:
  - jre\\bin\\java.exe が存在するか確認
  - lib フォルダに .jar ファイルが複数存在するか確認

■ セキュリティ
- パスワードはAES-128で暗号化されています
- データベースはローカルに保存されます

■ パッケージについて
このパッケージは jlink で生成された最小限のJREを含んでいます。
フットプリント削減のため、以下のモジュールのみを含みます:
  - java.base: Java基本モジュール
  - java.desktop: UI関連
  - java.logging: ログ機能
  - java.sql: データベース
  - java.naming: JNDI機能
  - jdk.unsupported: 互換性
  - java.management: 管理機能

Version: 1.0
Created: ${timestamp}
"""
        readmeFile.text = readmeContent
        
        // ZIPファイルを作成
        def zipFile = new File("$buildDirPath/distribution/PasswordManager-Windows.zip")
        
        logger.lifecycle("Creating ZIP archive...")
        project.exec {
            executable 'powershell.exe'
            args '-NoProfile', '-Command', 
                "Compress-Archive -Path \"${distDir.absolutePath}\" -DestinationPath \"${zipFile.absolutePath}\" -Force"
        }
        
        def sizeInMB = (zipFile.size() / (1024*1024)).toInteger()
        logger.lifecycle("""
========================================
✓ Windows配布パッケージ作成完了
========================================
パッケージ: ${zipFile.absolutePath}

内容:
  - Application JAR
  - すべての依存ライブラリ
  - 最小限Java実行環境（jlink生成）
  - 実行スクリプト（run.bat）
  - ドキュメント

利用方法:
  1. ZIPファイルを解凍
  2. run.bat をダブルクリック
  3. アプリケーション起動

パッケージサイズ: ${sizeInMB} MB
========================================
""")
    }
}

task printDistributionInfo {
    description = 'Show distribution package information'
    group = 'distribution'
    doLast {
        println """
配布用パッケージ作成タスク:
  gradle createWindowsDistributionWithJRE : Windows用パッケージ作成（最小限JRE同梱）

実行例:
  gradle createWindowsDistributionWithJRE

出力先:
  build/distribution/PasswordManager-Windows.zip

特徴:
  - jlink で生成された最小限のJRE
  - 不要なモジュール/ドキュメントを除外
  - --compress=2 で圧縮
  - フットプリント最小化
""".stripIndent()
    }
}
